/*! Nodedit 0.1.0 06-29-2013 */
nodedit.connect={view:function(){nodedit.template("connect.tpl").done(function(a){nodedit.$el.html(a),$("form#connect").on("submit",function(a){a.preventDefault(),nodedit.connect.process($(this).serializeArray())})})},process:function(a){var b=0,c=a.length,d={};for(b=0;c-1>=b;b++)d[a[b].name]=a[b].value;nodedit.fsapi.check(d).done(function(a){"success"===a.status?(nodedit.session(d),nodedit.workspace.init()):nodedit.message.error("Could not connect to server")}).fail(function(){nodedit.message.error("Could not connect to server")})},close:function(){nodedit.session("clear"),window.location.reload()}},nodedit.editor={el:"#editor",instance_el:"#instances",instances:{},instance_modes:{},init:function(){var a,b=this;nodedit.template("editor.tpl").done(function(a){nodedit.$el.find(b.el).html(a);var c=nodedit.$el.outerHeight()-nodedit.$el.find(".top-bar").outerHeight(!0);nodedit.$el.find(b.el).css({height:c+"px"})}),a=new nodedit.keybind({code:"ctrl s",callback:function(){nodedit.editor.saveActive()}})},open:function(a,b){var c,d,e=this,f=nodedit.filemanager.getFileExtension(a),g=e.getMode(f),h=!1;for(c in e.instances)e.instances[c].path===a&&(h=!0,d=c);h||(d=+new Date,e.instances[d]={path:a,content:b},nodedit.$el.find(e.instance_el).append('<li class="editor" id="editor'+d+'" data-id="'+d+'"></li>'),e.instances[d].editor=ace.edit("editor"+d),e.setMode(g,d),e.setConfig({theme:"twilight",fontsize:14,printmargin:!1,highlightline:!0,indentguides:!0},d),e.bindChange(d),e.setContent(b,d),nodedit.tabs.open(d,nodedit.filemanager.getFileName(a))),e.gotoInstance(d)},setConfig:function(a,b){var c=this;c.setTheme(a.theme,b),c.setFontSize(a.fontsize,b),c.setPrintMargin(a.printmargin,b),c.setHighlightLine(a.highlightline,b),c.setIndentGuides(a.indentguides,b)},close:function(a){var b=this;nodedit.tabs.close(a),nodedit.$el.find(b.instance_el).children('li[data-id="'+a+'"]').remove(),delete b.instances[a]},saveActive:function(){var a,b=this,c=nodedit.tabs.getActive();c?(a=b.getContent(c),nodedit.filemanager.saveFile(b.instances[c].path,a,function(d){d&&(nodedit.tabs.markUnchanged(c),b.instances[c].content=a)})):nodedit.message.error("No active files to save")},gotoInstance:function(a){var b=this;nodedit.tabs.setActive(a),nodedit.$el.find(b.instance_el).children("li").hide(),nodedit.$el.find(b.instance_el).children('li[data-id="'+a+'"]').show()},getPath:function(a){var b,c=this;for(b in c.instances)if(b==a)return c.instances[a].path;return!1},setContent:function(a,b){var c=this;c.instances[b].editor.getSession().setValue(a)},getContent:function(a){var b=this;return b.instances[a].editor.getSession().getValue()},getMode:function(a){switch(a){case"html":case"htm":case"tpl":return"html";case"js":return"javascript";case"css":return"css";case"scss":case"sass":return"scss";case"less":return"less";case"php":case"php5":return"php";case"json":return"json";case"xml":return"xml";case"sql":return"sql";case"md":return"markdown";default:return"text"}},setMode:function(a,b){var c=this;c.instances[b].editor.getSession().setMode("ace/mode/"+a)},setTheme:function(a,b){var c=this;c.instances[b].editor.setTheme("ace/theme/"+a)},setFontSize:function(a,b){var c=this;c.instances[b].editor.setFontSize(a)},setHighlightLine:function(a,b){var c=this;c.instances[b].editor.setHighlightActiveLine(a)},setPrintMargin:function(a,b){var c=this;c.instances[b].editor.setShowPrintMargin(a)},setIndentGuides:function(a,b){var c=this;c.instances[b].editor.setDisplayIndentGuides(a)},bindChange:function(a){var b=this;b.instances[a].editor.on("change",function(){nodedit.tabs.markChanged(a)})}},nodedit.filemanager={el:"#filemanager",init:function(){var a=this;nodedit.template("filemanager.tpl").done(function(b){nodedit.$el.find(a.el).html(b),a.openDirectory("/")}),nodedit.$el.find(a.el).on("click","a.directory",function(){var b=$(this).parent("li").data("path");$(this).parent("li").hasClass("open")?a.closeDirectory(b):a.openDirectory(b)}),nodedit.$el.find(a.el).on("click","a.file",function(){nodedit.filemanager.openFile($(this).parent("li").data("path"))}),nodedit.$el.find(a.el).on("contextmenu","a",function(b){a.contextMenu($(this).attr("class"),$(this).parent("li").data("path"),b)}),nodedit.$el.find(a.el).on("click","#disconnect",function(){nodedit.connect.close()})},contextMenu:function(a,b,c){c.preventDefault();var d=this,e=nodedit.$el.find(d.el).find('li[data-path="'+b+'"]').children("a");nodedit.template("filemanager_"+a+"_menu.tpl",b,function(a){nodedit.$el.find(d.el).append(a),nodedit.$el.find(d.el).children(".context-menu").css({top:c.pageY-20,left:c.pageX-20}),e.addClass("menu-open"),$("body").on("click",function(){nodedit.$el.find(d.el).children(".context-menu").remove(),e.removeClass("menu-open")}),$(".context-menu").on("mouseleave",function(){$(this).remove(),e.removeClass("menu-open")})})},openDirectory:function(a){var b=this;nodedit.fsapi.list(a,function(c){if(c){for(var d in c)c[d].icon="directory"===c[d].type?"icon-folder-close":"icon-file";nodedit.template("filemanager_dir.tpl",c,function(c){var d=nodedit.$el.find(b.el+' li[data-path="'+a+'"]');d.addClass("open").append(c),"root"!==d.attr("id")&&d.children("a").children("span").attr("class","icon-folder-open")})}else nodedit.message.error("Could not load directory")})},closeDirectory:function(a){var b=this,c=nodedit.$el.find(b.el+' li[data-path="'+a+'"]');c.removeClass("open").children("ul").remove(),c.children("a").children("span").attr("class","icon-folder-close")},openFile:function(a){nodedit.fsapi.open(a,function(b){b?(b="true"===b.toString()?"":b,nodedit.editor.open(a,b)):nodedit.message.error("Could not open file")})},saveFile:function(a,b,c){nodedit.fsapi.save(a,b,function(a){a?nodedit.message.success("File has been successfully saved"):nodedit.message.error("The file could not be saved"),c&&c(a)})},getFileName:function(a){var b=a.split("/");return b[b.length-1]},getFileExtension:function(a){var b=this.getFileName(a).split(".");return b[b.length-1]}},nodedit.fsapi={check:function(a){return $.get(a.url+"/"+a.key+"/dir/")},request:function(a,b,c,d){$.ajax({url:a,type:b,data:c,success:function(a){"success"===a.status?a.data?d(a.data):d(!0):d(!1)},error:function(){d(!1)}})},open:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/file"+a;nodedit.fsapi.request(c,"GET",null,b)},list:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/dir"+a;nodedit.fsapi.request(c,"GET",null,b)},create:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/"+b+a;nodedit.fsapi.request(d,"POST",null,c)},createFile:function(a,b){this.create(a,"file",b)},createDirectory:function(a,b){this.create(a,"dir",b)},copy:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/copy"+a;nodedit.fsapi.request(d,"POST",{destination:b},c)},move:function(a,b,c){var d=this;this.copy(a,b,function(b){"success"===b.status?d.delete(a,c):c(b)})},save:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/save"+a;nodedit.fsapi.request(d,"PUT",{data:b},c)},rename:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/rename"+a;nodedit.fsapi.request(d,"PUT",{name:b},c)},"delete":function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+a;nodedit.fsapi.request(c,"DELETE",{name:name},b)}};var nodedit={templates:"templates/",el:"#nodedit"};$(function(){nodedit.$el=$(nodedit.el),nodedit.session()?nodedit.workspace.init():nodedit.connect.view()}),nodedit.keybind=function(a){this.code=a.code||null,this.timeout=a.timeout||1e3,this.callback=a.callback||!1,this.cur_combo="",this.init=function(){var a=this;document.onkeydown=function(b){b=b||window.event;var c=a.keycodes[b.keyCode];a.cur_combo.length>0&&(a.cur_combo+=" "),a.cur_combo+=c,a.runTimer(),a.checkCode(b)}},this.runTimer=function(){var a=this;this.combotimer&&clearTimeout(this.combotimer),this.combotimer=setTimeout(function(){a.cur_combo=""},this.timeout)},this.checkCode=function(a){-1!==this.cur_combo.indexOf(this.code)&&this.callback&&(a.preventDefault(),this.cur_combo="",this.callback())},this.keycodes={8:"backspace",9:"tab",13:"enter",14:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"insert",46:"delete",48:"0",96:"0",49:"1",97:"1",50:"2",98:"2",51:"3",99:"3",52:"4",100:"4",53:"5",101:"5",54:"6",102:"6",55:"7",103:"7",56:"8",104:"8",57:"9",105:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equals",189:"minus",188:"comma",190:"period",191:"forwardslash",219:"openbracket",220:"backslash",221:"closebracket",222:"quote"},this.init()},nodedit.message={show:function(a,b){var c,d,e;$("#message").remove(),c="success"===b?"icon-thumbs-up":"icon-thumbs-down",$("body").append('<div id="message" class="'+b+'"><span class="'+c+'"></span>&nbsp;'+a+"</div>"),d=$("#message"),e=d.outerHeight(),d.css({bottom:"-"+e+"px",opacity:"0"}).animate({bottom:"0",opacity:"1"},500).delay(3e3).animate({bottom:"-"+e+"px",opacity:"0"},{complete:function(){$(this).remove()}},500)},error:function(a){nodedit.message.show(a,"error")},success:function(a){nodedit.message.show(a,"success")}},nodedit.modal={el:"#modal",open:function(a,b,c,d,e){this.close();var f=this;nodedit.$el.append('<div id="'+f.el.replace("#","")+'"></div>'),nodedit.$el.find(f.el).css({width:a+"px","margin-left":"-"+Math.round(a/2)+"px"}),nodedit.template(c,d,function(a){nodedit.template("modal.tpl",{title:b},function(b){nodedit.$el.find(f.el).html(b).children("#modal-content").html(a),e&&e()})}),nodedit.$el.find(f.el).on("click","a.icon-remove",function(){f.close()})},close:function(){var a=this;nodedit.$el.find(a.el).remove()}},nodedit.session=function(){if(!arguments.length){if(nodedit.store("nodedit_session")){var a=JSON.parse(nodedit.store("nodedit_session"));return{url:a.url,key:a.key}}return!1}"object"==typeof arguments[0]?nodedit.store("nodedit_session",arguments[0]):"clear"===arguments[0]&&nodedit.store("nodedit_session",null)},nodedit.store=function(a,b){return"undefined"!=typeof b&&null!==b&&("object"==typeof b&&(b=JSON.stringify(b)),localStorage.setItem(a,b)),"undefined"==typeof b?localStorage.getItem(a):(null===b&&localStorage.removeItem(a),void 0)},nodedit.tabs={el:"#tabs",open:function(a){var b=this,c=nodedit.editor.getPath(a),d=nodedit.filemanager.getFileName(c);nodedit.template("tab.tpl",{id:a,path:c,name:d},function(c){nodedit.$el.find(b.el).append(c),b.setActive(a),b.bindClose(a),b.bindClick(a)})},close:function(a){var b=this;nodedit.$el.find(b.el).children('[data-id="'+a+'"]').remove()},setActive:function(a){var b=this;nodedit.$el.find(b.el).children("li").removeClass("active"),nodedit.$el.find(b.el).children('[data-id="'+a+'"]').addClass("active")},getActive:function(){var a=this;return 0!==nodedit.$el.find(a.el).children("li.active").length?nodedit.$el.find(a.el).children("li.active").data("id"):!1},bindClose:function(a){var b=this;nodedit.$el.find(b.el).children('[data-id="'+a+'"]').on("click","a",function(){nodedit.editor.close(a)})},bindClick:function(a){var b=this;nodedit.$el.find(b.el).children('[data-id="'+a+'"]').on("click",function(){nodedit.editor.gotoInstance(a)})},markChanged:function(a){var b=this,c=nodedit.$el.find(b.el).children('li[data-id="'+a+'"]').children("label");nodedit.editor.getContent(a)!=nodedit.editor.instances[a].content?c.addClass("changed"):b.markUnchanged(a)},markUnchanged:function(a){var b=this;nodedit.$el.find(b.el).children('li[data-id="'+a+'"]').children("label").removeClass("changed")},checkChanged:function(a){var b,c=this;if(a){if(nodedit.$el.find(c.el).children('li[data-id="'+a+'"]').children("label").hasClass("changed"))return!0}else for(b in nodedit.editor.instances)if(nodedit.$el.find(c.el).children('li[data-id="'+b+'"]').children("label").hasClass("changed"))return!0;return!1}},nodedit.template=function(a,b,c){return $.ajax({url:nodedit.templates+a,type:"GET",success:function(a){if(b){var d=Handlebars.compile(a);a=d({data:b}),c(a)}},error:function(){nodedit.message.error("Could not load template")}})},Handlebars.registerHelper("eachkeys",function(a,b){var c=b.fn,d=b.inverse,e="",f=!0;for(key in a){f=!1;break}if(f)e=d(this);else for(key in a)e+=c({key:key,value:a[key]});return e}),nodedit.workspace={init:function(){nodedit.session()?nodedit.template("workspace.tpl").done(function(a){nodedit.$el.html(a),nodedit.filemanager.init(),nodedit.editor.init()}):nodedit.message.error("Could not load session")}};