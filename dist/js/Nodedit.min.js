/*! Nodedit 0.1.0 07-02-2013 */
var nodedit={templates:"dist/templates/",el:"#nodedit"};$(function(){nodedit.$el=$(nodedit.el),nodedit.session()?nodedit.workspace.init():nodedit.connect.view()}),$.fn.filterByData=function(a,b){return this.filter(function(){return $(this).data(a)==b})},nodedit.keybind=function(a){this.code=a.code||null,this.timeout=a.timeout||1e3,this.callback=a.callback||!1,this.cur_combo="",this.init=function(){var a=this;document.onkeydown=function(b){b=b||window.event;var c=a.keycodes[b.keyCode];a.cur_combo.length>0&&(a.cur_combo+=" "),a.cur_combo+=c,a.runTimer(),a.checkCode(b)}},this.runTimer=function(){var a=this;this.combotimer&&clearTimeout(this.combotimer),this.combotimer=setTimeout(function(){a.cur_combo=""},this.timeout)},this.checkCode=function(a){-1!==this.cur_combo.indexOf(this.code)&&this.callback&&(a.preventDefault(),this.cur_combo="",this.callback())},this.keycodes={8:"backspace",9:"tab",13:"enter",14:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"insert",46:"delete",48:"0",96:"0",49:"1",97:"1",50:"2",98:"2",51:"3",99:"3",52:"4",100:"4",53:"5",101:"5",54:"6",102:"6",55:"7",103:"7",56:"8",104:"8",57:"9",105:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equals",189:"minus",188:"comma",190:"period",191:"forwardslash",219:"openbracket",220:"backslash",221:"closebracket",222:"quote"},this.init()},nodedit.message={show:function(a,b){var c,d,e;$("#message").remove(),c="success"===b?"icon-thumbs-up":"icon-thumbs-down",$("body").append('<div id="message" class="'+b+'"><span class="'+c+'"></span>&nbsp;'+a+"</div>"),d=$("#message"),e=d.outerHeight(),d.css({bottom:"-"+e+"px",opacity:"0"}).animate({bottom:"0",opacity:"1"},500).delay(3e3).animate({bottom:"-"+e+"px",opacity:"0"},{complete:function(){$(this).remove()}},500)},error:function(a){nodedit.message.show(a,"error")},success:function(a){nodedit.message.show(a,"success")}},nodedit.template=function(a,b,c){return $.ajax({url:nodedit.templates+a,type:"GET",success:function(a){if(b){var d=Handlebars.compile(a);a=d({data:b}),c(a)}},error:function(){nodedit.message.error("Could not load template")}})},Handlebars.registerHelper("eachkeys",function(a,b){var c=b.fn,d=b.inverse,e="",f=!0;for(key in a){f=!1;break}if(f)e=d(this);else for(key in a)e+=c({key:key,value:a[key]});return e}),nodedit.fsapi={check:function(a){return $.get(a.url+"/"+a.key+"/dir/")},request:function(a,b,c,d){$.ajax({url:a,type:b,data:c,success:function(a){"success"===a.status?a.data?d(a.data):d(!0):d(!1)},error:function(){d(!1)}})},open:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/file"+a;nodedit.fsapi.request(c,"GET",null,b)},list:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/dir"+a;nodedit.fsapi.request(c,"GET",null,b)},create:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/"+b+a;nodedit.fsapi.request(d,"POST",null,c)},createFile:function(a,b){this.create(a,"file",b)},createDirectory:function(a,b){this.create(a,"dir",b)},copy:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/copy"+a;nodedit.fsapi.request(d,"POST",{destination:b},c)},move:function(a,b,c){var d=this;this.copy(a,b,function(b){"success"===b.status?d.delete(a,c):c(b)})},save:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/save"+a;nodedit.fsapi.request(d,"PUT",{data:b},c)},rename:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/rename"+a;nodedit.fsapi.request(d,"PUT",{name:b},c)},"delete":function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+a;nodedit.fsapi.request(c,"DELETE",{name:name},b)}},nodedit.session=function(){if(!arguments.length){if(nodedit.store("nodedit_session")){var a=JSON.parse(nodedit.store("nodedit_session"));return{url:a.url,key:a.key}}return!1}"object"==typeof arguments[0]?nodedit.store("nodedit_session",arguments[0]):"clear"===arguments[0]&&nodedit.store("nodedit_session",null)},nodedit.store=function(a,b){return"undefined"!=typeof b&&null!==b&&("object"==typeof b&&(b=JSON.stringify(b)),localStorage.setItem(a,b)),"undefined"==typeof b?localStorage.getItem(a):(null===b&&localStorage.removeItem(a),void 0)},nodedit.connect={view:function(){nodedit.template("connect.tpl").done(function(a){nodedit.$el.html(a),$("form#connect").on("submit",function(a){a.preventDefault(),nodedit.connect.process($(this).serializeArray())})})},process:function(a){var b=0,c=a.length,d={};for(b=0;c-1>=b;b++)d[a[b].name]=$.trim(a[b].value);nodedit.fsapi.check(d).done(function(a){"success"===a.status?(nodedit.session(d),nodedit.workspace.init()):nodedit.message.error("Could not connect to server")}).fail(function(){nodedit.message.error("Could not connect to server")})},close:function(){nodedit.session("clear"),window.location.reload()}},nodedit.modal={el:"#modal",open:function(a,b,c,d,e){this.close();var f=this;nodedit.$el.append('<div id="'+f.el.replace("#","")+'"></div>'),nodedit.$el.find(f.el).css({width:a+"px","margin-left":"-"+Math.round(a/2)+"px"}),nodedit.template(c,d,function(a){nodedit.template("modal.tpl",{title:b},function(b){nodedit.$el.find(f.el).html(b).children("#modal-content").html(a).find("input:first-of-type").focus(),e&&e()})}),nodedit.$el.find(f.el).on("click","a.icon-remove",function(){f.close()})},close:function(){var a=this;nodedit.$el.find(a.el).remove()}},nodedit.workspace={init:function(){nodedit.session()?nodedit.template("workspace.tpl").done(function(a){nodedit.$el.html(a),nodedit.filemanager.init(),nodedit.editor.init()}):nodedit.message.error("Could not load session")}},nodedit.tabs={el:"#tabs",open:function(a){var b=this,c=nodedit.editor.getPath(a),d=nodedit.filemanager.getFileName(c);nodedit.template("tab.tpl",{id:a,path:c,name:d},function(c){nodedit.$el.find(b.el).append(c),b.setActive(a),b.bindClose(a),b.bindClick(a)})},close:function(a){var b=this;nodedit.$el.find(b.el).children("li").filterByData("id",a).remove()},rename:function(a,b,c){var d=this,e=nodedit.$el.find(d.el).children("li").filterByData("id",c),f=e.attr("title");e.attr("title",e.attr("title").replace(a,b)),f===a&&e.children("label").text(nodedit.filemanager.getFileName(b))},setActive:function(a){var b=this;nodedit.$el.find(b.el).children("li").removeClass("active"),nodedit.$el.find(b.el).children("li").filterByData("id",a).addClass("active")},getActive:function(){var a=this;return 0!==nodedit.$el.find(a.el).children("li.active").length?nodedit.$el.find(a.el).children("li.active").data("id"):!1},bindClose:function(a){var b=this;nodedit.$el.find(b.el).children("li").filterByData("id",a).on("click","a",function(){nodedit.editor.close(a)})},bindClick:function(a){var b=this;nodedit.$el.find(b.el).children("li").filterByData("id",a).on("click",function(){nodedit.editor.gotoInstance(a)})},markChanged:function(a){var b=this,c=nodedit.$el.find(b.el).children("li").filterByData("id",a).children("label");nodedit.editor.getContent(a)!=nodedit.editor.instances[a].content?c.addClass("changed"):b.markUnchanged(a)},markUnchanged:function(a){var b=this;nodedit.$el.find(b.el).children("li").filterByData("id",a).children("label").removeClass("changed")},checkChanged:function(a){var b,c=this;if(a){if(nodedit.$el.find(c.el).children("li").filterByData("id",a).children("label").hasClass("changed"))return!0}else for(b in nodedit.editor.instances)if(nodedit.$el.find(c.el).children("li").filterByData("id",a).children("label").hasClass("changed"))return!0;return!1}},nodedit.filemanager={el:"#filemanager",clipboard:"",init:function(){var a=this;nodedit.template("filemanager.tpl").done(function(b){nodedit.$el.find(a.el).html(b),a.openDirectory("/")}),nodedit.$el.find(a.el).on("click","a.directory",function(){var b=$(this).parent("li").data("path");$(this).parent("li").hasClass("open")?a.closeDirectory(b):a.openDirectory(b)}),nodedit.$el.find(a.el).on("click","a.file",function(){nodedit.filemanager.openFile($(this).parent("li").data("path"))}),nodedit.$el.find(a.el).on("contextmenu","a",function(b){a.contextMenu($(this).attr("class"),$(this).parent("li").data("path"),b)}),nodedit.$el.find(a.el).on("click","#disconnect",function(){nodedit.connect.close()})},contextMenu:function(a,b,c){c.preventDefault();var d,e=this,f=nodedit.$el.find(e.el).find("li").filterByData("path",b).children("a");d="directory"===a?"dir":null,nodedit.template("filemanager_context_menu.tpl",{dir:d,clipboard:e.clipboard},function(a){nodedit.$el.find(e.el).append(a),nodedit.$el.find(e.el).children(".context-menu").css({top:c.pageY-20,left:c.pageX-20}),f.addClass("menu-open"),$(".context-menu").on("click","a",function(){switch($(this).attr("id")){case"new_file":e.createObject(b,"file");break;case"new_directory":e.createObject(b,"directory");break;case"rename":e.renameObject(b);break;case"copy":e.copyObject(b);break;case"paste":e.pasteObject(b);break;case"delete":e.deleteObject(b)}}),$("body").on("click",function(){nodedit.$el.find(e.el).children(".context-menu").remove(),f.removeClass("menu-open")}),$(".context-menu").on("mouseleave",function(){$(this).remove(),f.removeClass("menu-open")})})},openDirectory:function(a){var b=this;nodedit.fsapi.list(a,function(c){if(c){for(var d in c)c[d].icon="directory"===c[d].type?"icon-folder-close":"icon-file";nodedit.template("filemanager_dir.tpl",c,function(c){object=nodedit.$el.find(b.el+" li").filterByData("path",a),object.addClass("open").append(c),"root"!==object.attr("id")&&object.children("a").children("span").attr("class","icon-folder-open")})}else nodedit.message.error("Could not load directory")})},closeDirectory:function(a){var b=this,c=nodedit.$el.find(b.el+" li").filterByData("path",a);return"root"===c.attr("id")?!1:(c.removeClass("open").children("ul").remove(),c.children("a").children("span").attr("class","icon-folder-close"),void 0)},openFile:function(a){nodedit.fsapi.open(a,function(b){b?(b="true"===b.toString()?"":b,nodedit.editor.open(a,b)):nodedit.message.error("Could not open file")})},saveFile:function(a,b,c){nodedit.fsapi.save(a,b,function(a){a?nodedit.message.success("File has been successfully saved"):nodedit.message.error("The file could not be saved"),c&&c(a)})},getFileName:function(a){var b=a.split("/");return b[b.length-1]},getFileExtension:function(a){var b=this.getFileName(a).split(".");return b[b.length-1]},createObject:function(a,b){var c,d,e,f=this;nodedit.modal.open(350,"Create "+b,"filemanager_create.tpl",{type:b},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(g){g.preventDefault(),d=$(this).children('[name="name"]').val(),""===d?nodedit.message.error("Please enter a "+b+" name"):(c=(a+"/"+d).replace("//","/"),e="directory"===b?"dir":b,nodedit.fsapi.create(c,e,function(d){d?(f.appendObject(a,c,b),nodedit.modal.close()):nodedit.message.error("Could not create "+b)}))})})},appendObject:function(a,b,c){var d,e=this,f=nodedit.$el.find(e.el).find("li").filterByData("path",a),g=e.getFileName(b);return 0!==f.find("li").filterByData("path",b).length?!1:(f.hasClass("open")&&(d="directory"===c?"icon-folder-close":"icon-file",f.children("ul").append('<li data-path="'+b+'"><a class="'+c+'"><span class="'+d+'"></span>'+g+"</a></li>")),void 0)},renameObject:function(a){var b,c,d,e,f=this,g=f.getFileName(a),h=nodedit.$el.find(f.el).find("li").filterByData("path",a);return"root"===h.attr("id")?(nodedit.modal.close(),nodedit.message.error("Cannot rename the node root"),!1):(b=-1!==h.children("a").attr("class").indexOf("directory")?"directory":"file",nodedit.modal.open(350,"Rename","filemanager_rename.tpl",{path:a,name:g},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(i){i.preventDefault(),c=$(this).children('[name="name"]').val(),""===c||c===g?nodedit.message.error("Please enter a new "+b+" name"):nodedit.fsapi.rename(a,c,function(i){i?(e=a.replace(g,c),h.data("path",e),d=h.children("a").html().replace(g,c),h.children("a").html(d),"directory"===b&&$.each(nodedit.$el.find(f.el).find("li"),function(){0===$(this).data("path").indexOf(a)&&$(this).data("path")!==e&&$(this).data("path",$(this).data("path").replace(a,e))}),nodedit.editor.rename(a,e),nodedit.modal.close()):nodedit.message.error("Could not rename "+b)})})}),void 0)},copyObject:function(a){var b=this;b.clipboard=a,nodedit.message.success("Copied to clipboard")},pasteObject:function(a){var b=this,c=b.getFileName(b.clipboard),d=nodedit.$el.find(b.el).find("li").filterByData("path",b.clipboard).children("a").attr("class");nodedit.fsapi.copy(b.clipboard,a+"/"+c,function(e){e?b.appendObject(a,a+"/"+c,d):nodedit.message.error("Could not create a copy")})},deleteObject:function(a){var b=this;return"/"===a?(nodedit.modal.close(),nodedit.message.error("Cannot delete the node root"),!1):(nodedit.modal.open(350,"Delete?","filemanager_delete.tpl",{path:a},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(c){c.preventDefault(),nodedit.fsapi.delete(a,function(c){c?(nodedit.$el.find(b.el).find("li").filterByData("path",a).remove(),nodedit.modal.close()):nodedit.message.error("Could not delete object")})})}),void 0)}},nodedit.editor={el:"#editor",instance_el:"#instances",instances:{},instance_modes:{},init:function(){var a,b=this;nodedit.template("editor.tpl").done(function(a){nodedit.$el.find(b.el).html(a);var c=nodedit.$el.outerHeight()-nodedit.$el.find(".top-bar").outerHeight(!0);nodedit.$el.find(b.el).css({height:c+"px"})}),a=new nodedit.keybind({code:"ctrl s",callback:function(){nodedit.editor.saveActive()}})},open:function(a,b){var c,d,e=this,f=nodedit.filemanager.getFileExtension(a),g=e.getMode(f),h=!1;for(c in e.instances)e.instances[c].path===a&&(h=!0,d=c);h||(d=+new Date,e.instances[d]={path:a,content:b},nodedit.$el.find(e.instance_el).append('<li class="editor" id="editor'+d+'" data-id="'+d+'"></li>'),e.instances[d].editor=ace.edit("editor"+d),e.setMode(g,d),e.setConfig({theme:"twilight",fontsize:14,printmargin:!1,highlightline:!0,indentguides:!0},d),e.bindChange(d),e.setContent(b,d),nodedit.tabs.open(d,nodedit.filemanager.getFileName(a))),e.gotoInstance(d)},setConfig:function(a,b){var c,d=this,e=function(a,b,c){a.setTheme(b.theme,c),a.setFontSize(b.fontsize,c),a.setPrintMargin(b.printmargin,c),a.setHighlightLine(b.highlightline,c),a.setIndentGuides(b.indentguides,c)};if(b)e(d,a,b);else for(c in d.instances)e(d,a,c)},close:function(a){var b=this,c=function(a,b){nodedit.tabs.close(b),nodedit.$el.find(a.instance_el).children("li").filterByData("id",b).remove(),delete a.instances[b]};nodedit.tabs.checkChanged(a)?nodedit.modal.open(500,"Close Without Saving?","editor_confirm_close.tpl",{},function(){$(nodedit.modal.el).find("#diffreg").html(b.getDiff(a)),nodedit.$el.find(nodedit.modal.el).on("submit","form",function(d){d.preventDefault(),c(b,a),nodedit.modal.close()})}):c(b,a)},getDiff:function(a){var b=this,c=difflib.stringAsLines(b.instances[a].content),d=difflib.stringAsLines(b.getContent(a)),e=new difflib.SequenceMatcher(c,d),f=e.get_opcodes(),g=diffview.buildView({baseTextLines:c,newTextLines:d,opcodes:f,baseTextName:"Base Text",newTextName:"New Text",contextSize:null,viewType:1});return g},rename:function(a,b){var c,d=this;for(c in d.instances)0===d.instances[c].path.indexOf(a)&&(d.instances[c].path=d.instances[c].path.replace(a,b),nodedit.tabs.rename(a,b,c))},saveActive:function(){var a,b=this,c=nodedit.tabs.getActive();c?(a=b.getContent(c),nodedit.filemanager.saveFile(b.instances[c].path,a,function(d){d&&(nodedit.tabs.markUnchanged(c),b.instances[c].content=a)})):nodedit.message.error("No active files to save")},gotoInstance:function(a){var b=this;nodedit.tabs.setActive(a),nodedit.$el.find(b.instance_el).children("li").hide(),nodedit.$el.find(b.instance_el).children("li").filterByData("id",a).show()},getPath:function(a){var b,c=this;for(b in c.instances)if(b==a)return c.instances[a].path;return!1},setContent:function(a,b){var c=this;c.instances[b].editor.getSession().setValue(a)},getContent:function(a){var b=this;return b.instances[a].editor.getSession().getValue()},getMode:function(a){switch(a){case"html":case"htm":case"tpl":return"html";case"js":return"javascript";case"css":return"css";case"scss":case"sass":return"scss";case"less":return"less";case"php":case"php5":return"php";case"json":return"json";case"xml":return"xml";case"sql":return"sql";case"md":return"markdown";default:return"text"}},setMode:function(a,b){var c=this;c.instances[b].editor.getSession().setMode("ace/mode/"+a)},setTheme:function(a,b){var c=this;c.instances[b].editor.setTheme("ace/theme/"+a)},setFontSize:function(a,b){var c=this;c.instances[b].editor.setFontSize(a)},setHighlightLine:function(a,b){var c=this;c.instances[b].editor.setHighlightActiveLine(a)},setPrintMargin:function(a,b){var c=this;c.instances[b].editor.setShowPrintMargin(a)},setIndentGuides:function(a,b){var c=this;c.instances[b].editor.setDisplayIndentGuides(a)},bindChange:function(a){var b=this;b.instances[a].editor.on("change",function(){nodedit.tabs.markChanged(a)})}};