/*!
 Nodedit is free software released without warranty under the MIT license by Kent Safranski
 Build version 0.7.5, 08-04-2013
*/
var nodedit={templates:"templates/",el:"#nodedit",init:function(){nodedit.session()?nodedit.workspace.init():nodedit.connect.view(),nodedit.$el.on("contextmenu",function(a){a.stopPropagation(),a.preventDefault()}),nodedit.plugins.init()}};$(function(){nodedit.$el=$(nodedit.el),nodedit.env=$("body").attr("data-env"),"dist"===nodedit.env?$.get("dist/templates/system.tpl",function(a){$("body").append('<div id="nodedit-templates">'+a+"</div>")}).done(function(){nodedit.init()}):nodedit.init()}),$.fn.filterByData=function(a,b){return this.filter(function(){return $(this).data(a)==b})},nodedit.keybind=function(a){this.code=a.code||null,this.timeout=a.timeout||2e3,this.callback=a.callback||!1,this.cur_combo="",this.init=function(){var a=this;document.onkeydown=function(b){b=b||window.event;var c=a.keycodes[b.keyCode];a.cur_combo.length>0&&(a.cur_combo+=" "),a.cur_combo+=c,a.runTimer(),a.checkCode(b)}},this.runTimer=function(){var a=this;this.combotimer&&clearTimeout(this.combotimer),this.combotimer=setTimeout(function(){a.cur_combo=""},this.timeout)},this.checkCode=function(a){-1!==this.cur_combo.indexOf(this.code)&&this.callback&&(a.preventDefault(),this.cur_combo="",this.callback())},this.keycodes={8:"backspace",9:"tab",13:"enter",14:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"insert",46:"delete",48:"0",96:"0",49:"1",97:"1",50:"2",98:"2",51:"3",99:"3",52:"4",100:"4",53:"5",101:"5",54:"6",102:"6",55:"7",103:"7",56:"8",104:"8",57:"9",105:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equals",189:"minus",188:"comma",190:"period",191:"forwardslash",219:"openbracket",220:"backslash",221:"closebracket",222:"quote"},this.init()},nodedit.message={show:function(a,b){var c,d,e;$("#message").remove(),c="success"===b?"icon-thumbs-up":"icon-thumbs-down",$("body").append('<div id="message" class="'+b+'"><span class="'+c+'"></span>&nbsp;'+a+"</div>"),d=$("#message"),e=d.outerHeight(),d.css({bottom:"-"+e+"px",opacity:"0"}).animate({bottom:"0",opacity:"1"},500).delay(3e3).animate({bottom:"-"+e+"px",opacity:"0"},{complete:function(){$(this).remove()}},500)},error:function(a){nodedit.message.show(a,"error")},success:function(a){nodedit.message.show(a,"success")}},nodedit.template=function(a,b,c){var d,e,f;return a.indexOf("/")>=0?$.ajax({url:a,type:"GET",success:function(a){b&&(d=Handlebars.compile(a),a=d({data:b}),c(a))},error:function(){nodedit.message.error("Could not load template")}}):"src"===nodedit.env?$.ajax({url:nodedit.templates+a,type:"GET",success:function(a){b&&(d=Handlebars.compile(a),a=d({data:b}),c(a))},error:function(){nodedit.message.error("Could not load template")}}):(e=new $.Deferred,f=$('script[id="'+a+'"]').html(),d=Handlebars.compile(f),f=d({data:b}),e.resolve(f),"function"==typeof c&&c(f),e.promise())},Handlebars.registerHelper("eachkeys",function(a,b){var c,d=b.fn,e=b.inverse,f="",g=!0;for(c in a){g=!1;break}if(g)f=e(this);else for(c in a)f+=d({key:c,value:a[c]});return f}),Handlebars.registerHelper("ifCond",function(a,b,c,d){switch(b){case"==":return a==c?d.fn(this):d.inverse(this);case"===":return a===c?d.fn(this):d.inverse(this);case"<":return c>a?d.fn(this):d.inverse(this);case"<=":return c>=a?d.fn(this):d.inverse(this);case">":return a>c?d.fn(this):d.inverse(this);case">=":return a>=c?d.fn(this):d.inverse(this);default:return d.inverse(this)}}),nodedit.fsapi={check:function(a){return $.get(a.url+"/"+a.key+"/dir/")},request:function(a,b,c,d){$.ajax({url:a,type:b,data:c,success:function(a){"success"===a.status?a.data?d(a.data):d(!0):d(!1)},error:function(){d(!1)}})},open:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/file"+a;nodedit.fsapi.request(c,"GET",null,b)},list:function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+"/dir"+a;nodedit.fsapi.request(c,"GET",null,b)},create:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/"+b+a;nodedit.fsapi.request(d,"POST",null,c)},createFile:function(a,b){this.create(a,"file",b)},createDirectory:function(a,b){this.create(a,"dir",b)},copy:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/copy"+a;nodedit.fsapi.request(d,"POST",{destination:b},c)},move:function(a,b,c){var d=this;this.copy(a,b,function(b){"success"===b.status?d.delete(a,c):c(b)})},save:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/save"+a;nodedit.fsapi.request(d,"PUT",{data:b},c)},rename:function(a,b,c){var d=nodedit.session().url+"/"+nodedit.session().key+"/rename"+a;nodedit.fsapi.request(d,"PUT",{name:b},c)},"delete":function(a,b){var c=nodedit.session().url+"/"+nodedit.session().key+a;nodedit.fsapi.request(c,"DELETE",{name:name},b)}},nodedit.session=function(){if(!arguments.length){if(nodedit.store("nodedit_session")){var a=JSON.parse(nodedit.store("nodedit_session"));return{url:a.url,key:a.key}}return!1}"object"==typeof arguments[0]?nodedit.store("nodedit_session",arguments[0]):"clear"===arguments[0]&&nodedit.store("nodedit_session",null)},nodedit.store=function(a,b){return"undefined"!=typeof b&&null!==b&&("object"==typeof b&&(b=JSON.stringify(b)),localStorage.setItem(a,b)),"undefined"==typeof b?localStorage.getItem(a):(null===b&&localStorage.removeItem(a),void 0)},nodedit.connect={view:function(){nodedit.template("connect.tpl").done(function(a){nodedit.$el.html(a),$("form#connect").on("submit",function(a){a.preventDefault(),nodedit.connect.process($(this).serializeArray())})})},process:function(a){var b=0,c=a.length,d={};for(b=0;c-1>=b;b++)d[a[b].name]=$.trim(a[b].value);nodedit.fsapi.check(d).done(function(a){"success"===a.status?(nodedit.session(d),nodedit.workspace.init()):nodedit.message.error("Could not connect to server")}).fail(function(){nodedit.message.error("Could not connect to server")})},close:function(){nodedit.session("clear"),window.location.reload()}},nodedit.observer={topics:{},topic_id:0,publish:function(a,b){var c=this;return c.topics.hasOwnProperty(a)?(setTimeout(function(){var d,e=c.topics[a];if(!e.length)return!1;for(d=e.length;d--;)e[d].fn(b)},0),!0):!1},subscribe:function(a,b){var c,d,e=this,f=++this.topic_id;for(e.topics[a]||(e.topics[a]=[]),d=0,c=e.topics[a].length;c>d;d++)if(e.topics[a][d].fn.toString()===b.toString())return e.topics[a][d].id;return e.topics[a].push({id:f,fn:b}),f},unsubscribe:function(a){var b,c,d,e=this;for(b in e.topics)if(e.topics.hasOwnProperty(b))for(c=0,d=e.topics[b].length;d>c;c++)if(e.topics[b][c].id===a)return e.topics[b].splice(c,1),a;return!1}},nodedit.modal={el:"#modal",overlay:"#modal-overlay",open:function(a,b,c,d,e){this.close(),d=d||{},e=e||null;var f=this;nodedit.$el.append('<div id="'+f.overlay.replace("#","")+'"></div><div id="'+f.el.replace("#","")+'"></div>'),nodedit.$el.find(f.el).css({width:a+"px","margin-left":"-"+Math.round(a/2)+"px"}),nodedit.template(c,d,function(a){nodedit.template("modal.tpl",{title:b},function(b){nodedit.$el.find(f.el).html(b).children("#modal-content").html(a).find("input:not([type=hidden]):first").focus(),e&&e()})}),nodedit.$el.find(f.el).on("click","a.icon-remove, #btn-modal-close",function(a){a.preventDefault(),f.close()})},close:function(){var a=this;nodedit.$el.find(a.el+","+a.overlay).remove()}},nodedit.settings={init:function(){nodedit.store("nodedit_settings")||nodedit.store("nodedit_settings",{theme:"twilight",fontsize:14,printmargin:!1,highlightline:!0,indentguides:!0,wrapping:!1})},get:function(){return JSON.parse(nodedit.store("nodedit_settings"))},set:function(a){nodedit.store("nodedit_settings",a),nodedit.editor.setConfig()},edit:function(){var a=this,b=a.get();nodedit.modal.open(500,"Settings","settings.tpl",b,function(){var c=function(a){return"true"===a?!0:"false"===a?!1:a};nodedit.$el.find(nodedit.modal.el).on("change","select",function(){b[$(this).attr("name")]=c($(this).val()),a.set(b)})})}},nodedit.workspace={init:function(){nodedit.session()?nodedit.template("workspace.tpl").done(function(a){nodedit.$el.html(a),nodedit.settings.init(),nodedit.filemanager.init(),nodedit.editor.init()}):nodedit.message.error("Could not load session")}},nodedit.tabs={el:"#tabs",overflow_timeout:null,open:function(a){var b=this,c=nodedit.editor.getPath(a),d=nodedit.filemanager.getFileName(c);nodedit.template("tab.tpl",{id:a,path:c,name:d},function(c){nodedit.$el.find(b.el).append(c),b.setActive(a),b.bindClose(a),b.bindClick(a),b.sortable(),b.overflow()})},sortable:function(){var a=this;nodedit.$el.find(a.el).sortable({axis:"x",items:"li",containment:"parent",placeholder:"tab-sort-placeholder",distance:5})},overflow:function(){var a,b,c,d,e,f=this,g=nodedit.$el.find(f.el).children("li"),h=nodedit.$el.find(f.el).outerWidth();a=g.outerWidth(),b=g.length;var i=function(a){a.on("click",function(){nodedit.editor.gotoInstance($(this).data("id"))}),a.on("click","a",function(){nodedit.editor.close($(this).parent("li").data("id"))})};if(a*b>h-30){nodedit.$el.find("#tabs-reveal-menu").remove(),e=Math.ceil((a*b-(h-30))/a),nodedit.$el.find(f.el).append('<a id="tabs-reveal" class="icon-double-angle-right"></a>'),nodedit.$el.append('<ul id="tabs-reveal-menu"></ul>');for(var j=b-e,k=b;k>j;j++)c=nodedit.$el.find(f.el).children("li:eq("+j+")"),nodedit.$el.find("#tabs-reveal-menu").append('<li data-id="'+c.data("id")+'">'+c.html()+"</li>"),d=nodedit.$el.find("#tabs-reveal-menu").children('li[data-id="'+c.data("id")+'"]'),i(d);nodedit.$el.find(f.el).children("#tabs-reveal").on("click",function(){nodedit.$el.find("#tabs-reveal-menu").show()}),nodedit.$el.find("#tabs-reveal-menu").on("mouseleave",function(){$(this).hide()}),f.setActive(f.getActive())}else nodedit.$el.find(f.el).children("#tabs-reveal").remove(),nodedit.$el.find("#tabs-reveal-menu").remove();$(window).resize(function(){window.clearTimeout(f.overflow_timeout),f.overflow_timeout=setTimeout(function(){f.overflow()},250)})},close:function(a){var b,c=this,d=nodedit.$el.find(c.el).children("li").filterByData("id",a),e=d.index(),f=nodedit.$el.find(c.el).children("li").size()-1;if(d.remove(),d.hasClass("active")&&(e>0?b=e-1:f>e&&(b=e),void 0!==b)){var g=nodedit.$el.find(c.el).children("li:eq("+b+")").attr("data-id");nodedit.editor.gotoInstance(g)}c.sortable(),c.overflow()},rename:function(a,b,c){var d=this,e=nodedit.$el.find(d.el).children("li").filterByData("id",c),f=e.attr("title");e.attr("title",e.attr("title").replace(a,b)),f===a&&e.children("label").text(nodedit.filemanager.getFileName(b))},setActive:function(a){var b=this;nodedit.$el.find(b.el).children("li").removeClass("active"),nodedit.$el.find("#tabs-reveal-menu").children("li").removeClass("active"),nodedit.$el.find(b.el).children("li").filterByData("id",a).addClass("active"),nodedit.$el.find("#tabs-reveal-menu").children("li").filterByData("id",a).addClass("active")},getActive:function(){var a=this;return 0!==nodedit.$el.find(a.el).children("li.active").length?nodedit.$el.find(a.el).children("li.active").data("id"):!1},bindClose:function(a){var b=this;nodedit.$el.find(b.el).find("li").filterByData("id",a).on("click","a",function(b){b.stopPropagation(),nodedit.editor.close(a)})},bindClick:function(a){var b=this;nodedit.$el.find(b.el).find("li").filterByData("id",a).on("click",function(){nodedit.editor.gotoInstance(a)})},markChanged:function(a){var b=this,c=nodedit.$el.find(b.el).children("li").filterByData("id",a).children("label");nodedit.editor.getContent(a)!==nodedit.editor.instances[a].content?c.addClass("changed"):b.markUnchanged(a)},markUnchanged:function(a){var b=this;nodedit.$el.find(b.el).children("li").filterByData("id",a).children("label").removeClass("changed")},checkChanged:function(a){var b,c=this;if(a){if(nodedit.$el.find(c.el).children("li").filterByData("id",a).children("label").hasClass("changed"))return!0}else for(b in nodedit.editor.instances)if(nodedit.$el.find(c.el).children("li").filterByData("id",a).children("label").hasClass("changed"))return!0;return!1}},nodedit.bookmarks={nebfile:"/.nebmarks",getList:function(a){var b=this;nodedit.fsapi.open(b.nebfile,function(b){b.length<3||!b?a(!1):a(JSON.parse(b))})},showList:function(a){nodedit.$el.append('<div id="bookmark-menu"><ul></ul><hr><a id="edit-bookmarks"><span class="icon-edit"></span> Edit Bookmarks</a></div>');var b,c=this,d=nodedit.$el.find("#bookmark-menu"),e=nodedit.$el.find(a.target),f=e.position();c.getList(function(a){if(a){d.css({top:f.top+e.outerHeight()+5+"px",left:f.left-10+"px"}).on("mouseleave click",function(){d.remove()}),b='<li><a data-name="'+nodedit.filemanager.root_name+'" data-path="/"><span class="icon-cloud"></span> '+nodedit.filemanager.root_name+"</a></li>";for(var g in a)b+='<li><a data-name="'+g+'" data-path="'+a[g]+'"><span class="icon-star"></span> '+g+"</a></li>";d.show().children("ul").html(b),d.find("a").click(function(){"/"===$(this).data("path")?c.clearCurrent():"edit-bookmarks"===$(this).attr("id")?c.openDialog():c.setCurrent($(this).data("name"),$(this).data("path"))})}else nodedit.message.error("No bookmarks. Right-click directory to bookmark."),d.remove()})},openDialog:function(a){var b=this;b.getList(function(c){var d,e,f,g={},h=0,i=[],j={};a&&(g[h]={name:a.name,path:a.path,create:!0},h++);for(d in c)g[h]={name:d,path:c[d],create:!1},h++;nodedit.modal.open(500,"Bookmarks","bookmarks.tpl",g,function(){nodedit.$el.find(nodedit.modal.el).on("click",".icon-trash",function(){$(this).parent("td").parent("tr").remove()});var a=function(a,b){var c=b.children(),d=b.clone();return d.children().each(function(a){$(this).width(c.eq(a).width())}),d};nodedit.$el.find(nodedit.modal.el).find("table tbody").sortable({items:"tr",handle:".icon-resize-vertical",start:function(a,b){b.placeholder.height(b.item.height()),b.item.css("border","none")},helper:a}).disableSelection(),nodedit.$el.find(nodedit.modal.el).on("submit","form",function(a){for(a.preventDefault(),i=$(this).serializeArray(),h=0,e=i.length;e>h;h++)"name"===i[h].name?f=i[h].value:j[f]=i[h].value;b.saveList(j)})})})},addBookmark:function(a){var b=this;b.getList(function(c){var d;for(d in c)if(c[d]===a.path)return nodedit.message.error("Already bookmarked as "+d),!1;return"/"===a.path?(nodedit.message.error("You don&apos;t need to bookmark root"),!1):(b.openDialog(a),void 0)})},saveList:function(a){var b=this;nodedit.fsapi.createFile(b.nebfile,function(){nodedit.fsapi.save(b.nebfile,JSON.stringify(a,null,4),function(){nodedit.message.success("Bookmarks successfully saved")})})},setCurrent:function(a,b){nodedit.store("nodedit_bookmark",{name:a,path:b}),nodedit.filemanager.init()},clearCurrent:function(){nodedit.store("nodedit_bookmark",null),nodedit.filemanager.init()},getCurrent:function(){return JSON.parse(nodedit.store("nodedit_bookmark"))}},nodedit.filemanager={el:"#filemanager",clipboard:null,root_name:"Node Root",init:function(){var a=this,b="/",c=a.root_name,d=!1;nodedit.$el.find(a.el).html(""),nodedit.bookmarks.getCurrent()&&(b=nodedit.bookmarks.getCurrent().path,c=nodedit.bookmarks.getCurrent().name,d=!0),a.hasOwnProperty("bound")&&nodedit.$el.find(a.el).resizable("destroy"),nodedit.template("filemanager.tpl",{root:b,root_name:c,bookmark:d},function(c){nodedit.$el.find(a.el).html(c),a.openDirectory(b),a.bindActions()})},bindActions:function(){var a=this;nodedit.$el.find(a.el).resizable({handles:{e:"#resize-handle",w:"#resize-handle"},minWidth:65,resize:function(a,b){nodedit.editor.resize(b.size.width+"px")}}),a.hasOwnProperty("bound")||(nodedit.$el.find(a.el).on("click","a.directory",function(){var b=$(this).parent("li").data("path");$(this).parent("li").hasClass("open")?a.closeDirectory(b):a.openDirectory(b)}),nodedit.$el.find(a.el).on("click","a.file",function(){nodedit.filemanager.openFile($(this).parent("li").data("path"))}),$.event.props.push("dataTransfer"),nodedit.$el.find(a.el).on("dragover","a.directory",function(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy",$(".dragover").removeClass("dragover"),$(this).addClass("dragover"),nodedit.$el.on("mouseover dragover",function(){$(".dragover").removeClass("dragover")})}),nodedit.$el.find(a.el).on("drop","a.directory",function(b){b.stopPropagation(),b.preventDefault(),a.uploadDropFiles(b,$(this).parent("li").data("path"))}),nodedit.$el.find(a.el).on("contextmenu","a",function(b){"top-bar"!==$(this).parent().attr("class")&&a.contextMenu($(this).attr("class"),$(this).parent("li").data("path"),b)}),nodedit.$el.find(a.el).on("click","#disconnect",function(){nodedit.connect.close()}),nodedit.$el.find(a.el).on("click","#bookmarks",function(a){nodedit.bookmarks.showList(a)}),nodedit.$el.find(a.el).on("click","#plugins",function(a){nodedit.plugins.showList(a)}),nodedit.$el.find(a.el).on("click","#settings",function(){nodedit.settings.edit()}),nodedit.$el.find(a.el).on("click","#rescan",function(){a.rescan()}),a.bound=!0)},contextMenu:function(a,b,c){nodedit.$el.find(this.el).find(".context-menu").remove(),c.preventDefault();var d,e=this,f=nodedit.$el.find(e.el).find("li").filterByData("path",b).children("a");d="directory"===a?"dir":null,nodedit.template("filemanager_context_menu.tpl",{dir:d,clipboard:e.clipboard},function(a){nodedit.$el.find(e.el).append(a),nodedit.$el.find(e.el).children(".context-menu").css({top:c.pageY-20,left:c.pageX-20}),f.addClass("menu-open"),$(".context-menu").on("click","a",function(){switch($(this).attr("id")){case"new_file":e.createObject(b,"file");break;case"new_directory":e.createObject(b,"directory");break;case"bookmark":nodedit.bookmarks.addBookmark({name:e.getFileName(b),path:b});break;case"rename":e.renameObject(b);break;case"copy":e.copyObject(b);break;case"paste":e.pasteObject(b);break;case"delete":e.deleteObject(b)}}),$("body").on("click",function(){nodedit.$el.find(e.el).children(".context-menu").remove(),f.removeClass("menu-open")}),$(".context-menu").on("mouseleave",function(){$(this).remove(),f.removeClass("menu-open")})})},uploadDropFiles:function(a,b){var c=this;$.each(a.dataTransfer.files,function(){var a,d,e=this,f=new FileReader;f.onload=function(){a=this.result,d="/"!==b?b+"/"+e.name:b+e.name,nodedit.fsapi.createFile(d,function(f){f?nodedit.fsapi.save(d,a,function(a){a?(c.appendObject(b,d,"file"),nodedit.message.success("Successfully uploaded "+e.name)):nodedit.message.error("Could not save contents of "+e.name)}):nodedit.message.error("Could not create "+e.name)})},f.readAsBinaryString(e)})},rescan:function(){var a=this,b=[],c=0,d=nodedit.$el.find(a.el).children("#fm-container").children("#rescan");d.addClass("icon-spin"),nodedit.$el.find(a.el).children("#fm-container").find("li").filterByData("type","directory").each(function(){$(this).hasClass("open")&&b.push($(this).attr("data-path"))});var e=function(a,b,c,d){d.openDirectory(b[a]);var f=nodedit.observer.subscribe("filemanager_opendir",function(g){g===b[a]&&(nodedit.observer.unsubscribe(f),a<b.length-1?(a++,e(a,b,c,d)):c.removeClass("icon-spin"))})};e(c,b,d,a)},openDirectory:function(a){var b=this;nodedit.fsapi.list(a,function(c){if(c){for(var d in c)c[d].icon="directory"===c[d].type?"icon-folder-close":"icon-file";nodedit.template("filemanager_dir.tpl",c,function(c){var d;d=nodedit.$el.find(b.el+" li").filterByData("path",a),d.children("ul").remove(),d.addClass("open").append(c),"root"!==d.attr("id")&&d.children("a").children("span").attr("class","icon-folder-open"),setTimeout(function(){nodedit.observer.publish("filemanager_opendir",a)},15)})}else nodedit.message.error("Could not load directory")})},closeDirectory:function(a){var b=this,c=nodedit.$el.find(b.el+" li").filterByData("path",a);return"root"===c.attr("id")?!1:(c.removeClass("open").children("ul").remove(),c.children("a").children("span").attr("class","icon-folder-close"),void 0)},openFile:function(a){nodedit.fsapi.open(a,function(b){b?(b="true"===b.toString()?"":b,nodedit.editor.open(a,b)):nodedit.message.error("Could not open file")})},saveFile:function(a,b,c){nodedit.fsapi.save(a,b,function(a){a?nodedit.message.success("File has been successfully saved"):nodedit.message.error("The file could not be saved"),c&&c(a)})},getFileName:function(a){var b=a.split("/");return b[b.length-1]},getFileExtension:function(a){var b=this.getFileName(a).split(".");return b[b.length-1]},createObject:function(a,b){var c,d,e,f=this;nodedit.modal.open(350,"Create "+b,"filemanager_create.tpl",{type:b},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(g){g.preventDefault(),d=$(this).children('[name="name"]').val(),""===d?nodedit.message.error("Please enter a "+b+" name"):(c=(a+"/"+d).replace("//","/"),e="directory"===b?"dir":b,nodedit.fsapi.create(c,e,function(d){d?(f.appendObject(a,c,b),nodedit.modal.close()):nodedit.message.error("Could not create "+b)}))})})},appendObject:function(a,b,c){var d,e=this,f=nodedit.$el.find(e.el).find("li").filterByData("path",a),g=e.getFileName(b);return 0!==f.find("li").filterByData("path",b).length?!1:(f.hasClass("open")&&(d="directory"===c?"icon-folder-close":"icon-file",f.children("ul").append('<li data-path="'+b+'"><a class="'+c+'"><span class="'+d+'"></span>'+g+"</a></li>")),void 0)},renameObject:function(a){var b,c,d,e,f=this,g=f.getFileName(a),h=nodedit.$el.find(f.el).find("li").filterByData("path",a);return"root"===h.attr("id")?(nodedit.modal.close(),nodedit.message.error("Cannot rename the node root"),!1):(b=-1!==h.children("a").attr("class").indexOf("directory")?"directory":"file",nodedit.modal.open(350,"Rename","filemanager_rename.tpl",{path:a,name:g},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(i){i.preventDefault(),c=$(this).children('[name="name"]').val(),""===c||c===g?nodedit.message.error("Please enter a new "+b+" name"):nodedit.fsapi.rename(a,c,function(i){i?(e=a.replace(g,c),h.data("path",e),d=h.children("a").html().replace(g,c),h.children("a").html(d),"directory"===b&&$.each(nodedit.$el.find(f.el).find("li"),function(){0===$(this).data("path").indexOf(a)&&$(this).data("path")!==e&&$(this).data("path",$(this).data("path").replace(a,e))}),nodedit.editor.rename(a,e),nodedit.modal.close()):nodedit.message.error("Could not rename "+b)})})}),void 0)},copyObject:function(a){var b=this;b.clipboard=a,nodedit.message.success("Copied to clipboard")},pasteObject:function(a){var b=this,c=b.getFileName(b.clipboard),d=nodedit.$el.find(b.el).find("li").filterByData("path",b.clipboard).children("a").attr("class");nodedit.$el.find(b.el).find("li").filterByData("path",a+"/"+c).length>0&&(c="copy_of_"+c),nodedit.fsapi.copy(b.clipboard,a+"/"+c,function(e){e?b.appendObject(a,a+"/"+c,d):nodedit.message.error("Could not create a copy")})},deleteObject:function(a){var b=this;return"/"===a?(nodedit.modal.close(),nodedit.message.error("Cannot delete the node root"),!1):(nodedit.modal.open(350,"Delete?","filemanager_delete.tpl",{path:a},function(){nodedit.$el.find(nodedit.modal.el).on("submit","form",function(c){c.preventDefault(),nodedit.fsapi.delete(a,function(c){c?(nodedit.$el.find(b.el).find("li").filterByData("path",a).remove(),nodedit.modal.close()):nodedit.message.error("Could not delete object")})})}),void 0)}},nodedit.editor={el:"#editor",instance_el:"#instances",instances:{},instance_modes:{},available_extensions:{coffee:"coffee",css:"css",html:"html",htm:"html",tpl:"html",twig:"html",js:"javascript",json:"json",jsp:"jsp",less:"less",md:"markdown",php:"php",php5:"php",py:"python",rb:"ruby",sass:"sass",scss:"scss",sh:"sh",sql:"sql",txt:"text",text:"text",xml:"xml",svg:"xml"},init:function(){var a,b=this,c=nodedit.observer;nodedit.template("editor.tpl").done(function(a){nodedit.$el.find(b.el).html(a);var c=nodedit.$el.outerHeight()-nodedit.$el.find(".top-bar").outerHeight(!0);nodedit.$el.find(b.el).css({height:c+"px"})}),a=new nodedit.keybind({code:"ctrl s",callback:function(){nodedit.editor.saveActive()}}),c.subscribe("editor_change",function(a){nodedit.tabs.markChanged(a)}),c.subscribe("editor_cursor",function(a){var c=nodedit.$el.find(b.el).children("#position");clearTimeout(b.postimer),c.css({opacity:.7}),c.children(".ln").html("Line "+a.line),c.children(".ch").html("Char "+a.char),b.postimer=setTimeout(function(){c.css({opacity:.3})},1e3)})},open:function(a,b){var c,d,e=this,f=nodedit.filemanager.getFileExtension(a),g=e.getMode(f),h=!1;for(c in e.instances)e.instances[c].path===a&&(h=!0,d=c);return g?(h||(d=+new Date,e.instances[d]={path:a,content:b},nodedit.$el.find(e.instance_el).append('<li class="editor" id="editor'+d+'" data-id="'+d+'"></li>'),e.instances[d].editor=ace.edit("editor"+d),e.setMode(g,d),e.setConfig(d),e.emitter(d),e.bindContextMenu(d),e.setContent(b,d),nodedit.tabs.open(d),e.instances[d].editor.focus()),e.gotoInstance(d),void 0):(nodedit.message.error("Can not open file type "+f),!1)},setConfig:function(a){var b,c=this,d=nodedit.settings.get(),e=function(a,b,c){a.setTheme(b.theme,c),a.setFontSize(parseInt(b.fontsize,10),c),a.setPrintMargin(b.printmargin,c),a.setHighlightLine(b.highlightline,c),a.setIndentGuides(b.indentguides,c),a.setWrapping(b.wrapping,c)};if(a)e(c,d,a);else for(b in c.instances)e(c,d,b)},bindContextMenu:function(a){var b,c=this;c.instances[a].editor.textInput.onContextMenu=function(d){d.preventDefault(),b=c.instances[a].mode,nodedit.template("editor_context_menu.tpl",{id:a,curmode:b},function(e){nodedit.$el.find(c.el).append(e),nodedit.$el.find(c.el).children(".context-menu").css({top:d.pageY-20,left:d.pageX-20}),$(".context-menu").on("click","a",function(){switch($(this).attr("id")){case"save":c.saveActive();break;case"close":c.close(a);break;case"mode":c.changeMode(a,b);break;case"settings":nodedit.settings.edit()}}),$(".context-menu").on("mouseleave",function(a){a.stopPropagation(),$(this).remove()})})}},changeMode:function(a,b){var c,d,e=this,f={};for(c in e.available_extensions)-1===$.inArray(e.available_extensions[c],f)&&(d=!1,e.available_extensions[c]===b&&(d=!0),f[e.available_extensions[c]]=d);nodedit.modal.open(350,"Editor Mode","editor_change_mode.tpl",{modes:f,curmode:b},function(){nodedit.$el.find(nodedit.modal.el).find("form").on("submit",function(b){b.preventDefault(),e.setMode($(this).children('select[name="mode"]').children("option:selected").val(),a),nodedit.modal.close()})})},resize:function(a){var b,c=this;nodedit.$el.find(c.el).css({"margin-left":a});for(b in c.instances)c.instances[b].editor.resize()},close:function(a){var b=this,c=function(a,b){nodedit.tabs.close(b),nodedit.$el.find(a.instance_el).children("li").filterByData("id",b).remove(),delete a.instances[b]};nodedit.tabs.checkChanged(a)?nodedit.modal.open(500,"Close Without Saving?","editor_confirm_close.tpl",{},function(){$(nodedit.modal.el).find("#diffreg").html(b.getDiff(a)),nodedit.$el.find(nodedit.modal.el).on("submit","form",function(d){d.preventDefault(),c(b,a),nodedit.modal.close()})}):c(b,a)},getDiff:function(a){var b=this,c=difflib.stringAsLines(b.instances[a].content),d=difflib.stringAsLines(b.getContent(a)),e=new difflib.SequenceMatcher(c,d),f=e.get_opcodes(),g=diffview.buildView({baseTextLines:c,newTextLines:d,opcodes:f,baseTextName:"Base Text",newTextName:"New Text",contextSize:null,viewType:1});return g},rename:function(a,b){var c,d=this;for(c in d.instances)0===d.instances[c].path.indexOf(a)&&(d.instances[c].path=d.instances[c].path.replace(a,b),nodedit.tabs.rename(a,b,c))},saveActive:function(){var a,b=this,c=nodedit.tabs.getActive();c?(a=b.getContent(c),nodedit.filemanager.saveFile(b.instances[c].path,a,function(d){d&&(nodedit.tabs.markUnchanged(c),b.instances[c].content=a)})):nodedit.message.error("No active files to save")},gotoInstance:function(a){var b=this;nodedit.tabs.setActive(a),nodedit.$el.find(b.instance_el).children("li").hide(),nodedit.$el.find(b.instance_el).children("li").filterByData("id",a).show()},getPath:function(a){var b,c=this;for(b in c.instances)if(parseInt(b,10)===parseInt(a,10))return c.instances[a].path;return!1},setContent:function(a,b){var c=this;c.instances[b].editor.getSession().setValue(a)},getContent:function(a){var b=this;return a=a||nodedit.tabs.getActive(),a?b.instances[a].editor.getSession().getValue():!1},getMode:function(a){return a=a.length>4?"text":a,this.available_extensions[a]?this.available_extensions[a]:!1},setMode:function(a,b){var c=this;c.instances[b].editor.getSession().setMode("ace/mode/"+a),c.instances[b].mode=a},setTheme:function(a,b){var c=this;c.instances[b].editor.setTheme("ace/theme/"+a)},setFontSize:function(a,b){var c=this;c.instances[b].editor.setFontSize(a)},setHighlightLine:function(a,b){var c=this;c.instances[b].editor.setHighlightActiveLine(a)},setPrintMargin:function(a,b){var c=this;c.instances[b].editor.setShowPrintMargin(a)},setIndentGuides:function(a,b){var c=this;c.instances[b].editor.setDisplayIndentGuides(a)},setWrapping:function(a,b){var c=this;c.instances[b].editor.getSession().setUseWrapMode(a)},emitter:function(a){var b=this,c=nodedit.observer;b.instances[a].editor.on("change",function(){c.publish("editor_change",a)}),b.instances[a].editor.on("blur",function(){c.publish("editor_blur",a)}),b.instances[a].editor.on("focus",function(){c.publish("editor_focus",a)}),b.instances[a].editor.selection.on("changeCursor",function(){var c,d,e,f,g,h;c=b.instances[a].editor.getCursorPosition().row+1,d=b.instances[a].editor.getCursorPosition().column+1,e=nodedit.$el.find(b.instance_el).children("li").filterByData("id",a).find(".ace_cursor"),setTimeout(function(){f=e.offset(),g=f.top,h=f.left,nodedit.observer.publish("editor_cursor",{id:a,line:c,"char":d,top:g,left:h})},4)})}},nodedit.plugin={},nodedit.plugins={plugin_menu:{},init:function(){var a=this;nodedit.plugins.plugin_dir="dist"===nodedit.env?"plugins/":"../plugins/",$.getJSON(nodedit.plugins.plugin_dir+"plugins.json",function(b){var c;for(c in b)a.register(c,b[c])})},register:function(name,directory){var _this=this;$.get(_this.plugin_dir+directory+"/plugin.js",function(plugin){var tpl;if(plugin=eval(plugin),plugin.hasOwnProperty("onMenu")&&(_this.plugin_menu[name]={icon:plugin.icon,object:directory}),plugin.hasOwnProperty("templates"))for(tpl in plugin.templates)plugin.templates[tpl]=nodedit.plugins.plugin_dir+directory+"/"+plugin.templates[tpl];plugin.hasOwnProperty("dependencies")&&plugin.dependencies.length>0?_this.loadDependencies(plugin.dependencies,nodedit.plugins.plugin_dir+directory+"/",function(){plugin.hasOwnProperty("init")&&plugin.init()}):plugin.hasOwnProperty("init")&&plugin.init()})},loadDependencies:function(a,b,c){for(var d=0,e=a.length,f=function(){d++,d===e&&"function"==typeof c&&c.call()},g=function(a){var c,d=a.split(".").pop();if("js"===d){c=document.createElement("script"),c.type="text/javascript",c.async=!0,c.src=b+a,c.addEventListener("load",function(a){f(a)},!1);var e=document.getElementsByTagName("body")[0];e.appendChild(c)}else if("css"===d){c=document.createElement("link"),c.type="text/css",c.rel="stylesheet",c.href=b+a,c.async=!0,c.addEventListener("load",function(a){f(a)},!1);var g=document.getElementsByTagName("head")[0];g.appendChild(c)}else f({})},h=0;h<a.length;h++)g(a[h])},showList:function(a){nodedit.$el.append('<div id="plugin-menu"><ul></ul></div>');var b=this,c="",d=nodedit.$el.find("#plugin-menu"),e=nodedit.$el.find(a.target),f=e.position();if($.isEmptyObject(b.plugin_menu))nodedit.message.error("No plugins have been installed"),d.remove();else{d.css({top:f.top+e.outerHeight()+5+"px",left:f.left-10+"px"}).on("mouseleave click",function(){d.remove()});for(var g in b.plugin_menu)c+='<li><a id="plugin-'+b.plugin_menu[g].object+'"><span class="'+b.plugin_menu[g].icon+'"></span> '+g+"</a></li>";d.show().children("ul").html(c);var h=function(a){$("#plugin-"+a).bind("click",function(){nodedit.plugin[a].hasOwnProperty("onMenu")&&nodedit.plugin[a].onMenu()})};for(g in nodedit.plugin)h(g)}}};